apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "statefulsetName" . }}
  labels:
{{ include "labels" . | indent 4 }}
spec:
  replicas: {{ .Values.deployment.replicas }}
  revisionHistoryLimit: 3
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
{{ include "selectorLabels" . | indent 6 }}
  serviceName: {{ include "statefulsetName" . }}
  template:
    metadata:
      {{- if .Values.deployment.annotations }}
      annotations:
{{ tpl .Values.deployment.annotations . | indent 8 }}
      {{- end }}
      labels:
{{ include "labels" . | indent 8 }}
    spec:
      securityContext:
        runAsUser: 1000
        fsGroup: 1000
        runAsNonRoot: true
      containers:
        - name: {{ .Release.Name }}
          image: {{ .Values.image.repo }}:{{ .Values.image.tag }}
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
            capabilities:
              add:
                - SYS_TIME
          env:
            - name: GOLOOP_BACKUP_DIR
              value: {{ .Values.node.backupDirectory }}
            - name: GOLOOP_CONFIG
              value: {{ .Values.node.config }}
            - name: GOLOOP_CONSOLE_LEVEL
              value: {{ .Values.node.consoleLevel | default "trace" }}
            - name: GOLOOP_EE_SOCKET
              value: {{ .Values.node.network.ee.socket }}
            - name: GOLOOP_ENGINES
              value: {{ .Values.node.engines | default "python" }}
            - name: GOLOOP_KEY_PASSWORD
              value: {{ .Values.node.key.password }}
            - name: GOLOOP_KEY_PLUGIN
              value: {{ .Values.node.key.plugin }}
            - name: GOLOOP_KEY_PLUGIN_OPTIONS
              value: {{ .Values.node.key.pluginOptions }}
            - name: GOLOOP_KEY_SECRET
              value: {{ .Values.node.key.secret }}
            - name: GOLOOP_KEY_STORE
              value: {{ .Values.node.key.store }}
            - name: GOLOOP_LOG_FORWARDER_ADDRESS
              value: {{ .Values.node.log.forwarder.address }}
            - name: GOLOOP_LOG_FORWARDER_LEVEL
              value: {{ .Values.node.log.forwarder.level | default "info" }}
            - name: GOLOOP_LOG_FORWARDER_NAME
              value: {{ .Values.node.log.forwarder.name }}
            - name: GOLOOP_LOG_FORWARDER_OPTIONS
              value: {{ .Values.node.log.forwarder.options }}
            - name: GOLOOP_LOG_FORWARDER_VENDOR
              value: {{ .Values.node.log.forwarder.vendor }}
            - name: GOLOOP_LOG_LEVEL
              value: {{ .Values.node.log.level | default "debug" }}
            - name: GOLOOP_LOG_WRITER_COMPRESS
              value: {{ .Values.node.log.writer.compress | default "false" | quote }}
            - name: GOLOOP_LOG_WRITER_FILENAME
              value: {{ .Values.node.log.writer.filename }}
            - name: GOLOOP_LOG_WRITER_LOCALTIME
              value: {{ .Values.node.log.writer.localtime | default "false" | quote }}
            - name: GOLOOP_LOG_WRITER_MAXAGE
              value: {{ .Values.node.log.writer.maxAge | default "0" | quote }}
            - name: GOLOOP_LOG_WRITER_MAXBACKUPS
              value: {{ .Values.node.log.writer.maxBackups | default "0" | quote }}
            - name: GOLOOP_LOG_WRITER_MAXSIZE
              value: {{ .Values.node.log.writer.maxSize | default "100" | quote }}
            - name: GOLOOP_NODE_DIR
              value: {{ .Values.node.directory | default "/data"}}
            - name: GOLOOP_NODE_SOCK
              value: {{ .Values.node.socket }}
            - name: GOLOOP_P2P
              value: "{{ .Values.node.network.p2p.advertise | default "127.0.0.1" }}:{{ .Values.node.network.p2p.port | default "8080" }}"
            - name: GOLOOP_P2P_LISTEN
              value: {{ .Values.node.network.p2p.listen }}
            - name: GOLOOP_RPC_ADDR
              value: ":{{ .Values.node.network.rpc.address }}"
            - name: GOLOOP_RPC_DUMP
              value: {{ .Values.node.network.rpc.dump | default "false" | quote }}
          ports:
            - containerPort: {{ .Values.node.network.p2p.port }}
              name: p2p
            - containerPort: {{ .Values.node.network.rpc.address }}
              name: rpc
          livenessProbe:
            failureThreshold: 100
            tcpSocket:
              port: rpc
            initialDelaySeconds: 10
            periodSeconds: 10
          volumeMounts:
            - name: {{ template "dataPVCName" . }}
              mountPath: /data
          resources:
{{ toYaml .Values.deployment.resources | indent 12 }}
  volumeClaimTemplates:
    - metadata:
        name: {{ template "dataPVCName" . }}
      spec:
        accessModes: {{ .Values.deployment.storage.accessModes }}
        storageClassName: {{ .Values.deployment.storage.storageClassName }}
        resources:
          requests:
            storage: {{ .Values.deployment.storage.dataSize }}
